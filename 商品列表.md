

# 	1.1 java上传文件到fastDFS服务

   在 mingrui-shop-basic-upload-server 的 pom.xml 中添加

```
<!--java上传到fastDFS服务-->
<dependency>
    <groupId>com.github.tobato</groupId>
    <artifactId>fastdfs-client</artifactId>
    <version>1.26.1-RELEASE</version>
</dependency>
```

```
fdds:
  so-timeout: 1501
  connect-timeout: 601
  thumb-image:
    width: 60
    height: 60
  tracker-list:
    - 49.232.110.103:22122   #该为自己的端口号
mingrui:
  upload:
    path:
      windows: D:\\images
      linux: /hjh/images
    img:
      host: http://49.232.110.103/
    		
```

### 1.1.1 config包下新建配置类FastClientImporter

```java
package com.baidu.config;

import com.github.tobato.fastdfs.FdfsClientConfig;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableMBeanExport;
import org.springframework.context.annotation.Import;
import org.springframework.jmx.support.RegistrationPolicy;

@Configuration
@Import(FdfsClientConfig.class)
// 解决jmx重复注册bean的问题
@EnableMBeanExport(registration = RegistrationPolicy.IGNORE_EXISTING)
public class FastClientImporter {
}
```

### 1.1.2 上传文件controller

```java
package com.baidu.shop.upload.controller;

import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.github.tobato.fastdfs.domain.StorePath;
import com.github.tobato.fastdfs.domain.ThumbImageConfig;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.Resource;
import java.io.IOException;
import java.io.InputStream;


@RestController
@RequestMapping(value = "upload")
@Slf4j
public class FastDFSUploadController {
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;

    @Resource
    private FastFileStorageClient storageClient;

    @Resource
    private ThumbImageConfig thumbImageConfig;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) throws IOException {
        InputStream inputStream = file.getInputStream();//获取文件输入流
        String filename = file.getOriginalFilename();//文件名
        String ex = filename.substring(filename.lastIndexOf(".") + 1);//文件后缀名
        // 上传并且生成缩略图
        StorePath storePath = this.storageClient.uploadImageAndCrtThumbImage(
                inputStream, file.getSize(), ex, null);//上传
        // 带分组的路径
        log.info("上传图片全路径:{}", storePath.getFullPath());
        // 不带分组的路径
        log.info("上传图片路径:{}", storePath.getPath());
        // 获取缩略图路径
        String path =
                thumbImageConfig.getThumbImagePath(storePath.getFullPath());
        log.info("缩略图路径:{}", path);
        return new Result<String>(HTTPStatus.OK,"上传成功",imgHost + path);
    }

}
```

# 2.2  商品管理(查询)

### 	2.2.1 Goods.vue

​	第4行

```vue
	 <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
       </v-btn-toggle>
```

第204行

```vue
getDataFromApi() {
        this.loading = true;
        this.$http.get('goods/getSpuInfo',{
          params:{
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            saleable: this.search.saleable,
            title: this.search.key
          }
        }).then(resp =>{
          this.items = resp.data.data.list;
          this.totalItems = resp.data.data.total;
          this.loading = false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
```

### 2.2.2 查询

#### 	2.2.2.1  在 mingrui-shop-service-api-xxx  的entity包下新建SpuEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Table(name = "tb_spu")
@Data
public class SpuEntity {
    @Id
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;
}
```

#### 2.2.2.2  dto包下新建SpuDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;
import java.util.Date;

@ApiModel(value = "spu数据传出DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键" ,example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotNull(message = "标题不能为空",groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "一级类目id",example = "1")
    @NotNull(message = "一级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "二级类目id",example = "1")
    @NotNull(message = "二级类目的不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "三级类目id",example = "1")
    @NotNull(message = "三级类目的不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;
}
```

#### 2.2.2.3  service包下新建GoodsService



```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.SpuEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;


@Api(tags = "商品接口")
public interface GoodsService {

    //查询
    @ApiOperation(value = "获取spu的信息")
    @GetMapping(value = "goods/getSpuInfo")
    public Result<PageInfo<SpuEntity>> getSpuInfo(SpuDTO spuDTO);
}
```

#### 2.2.2.4  mingrui-shop-service-xxx 的 mapper包下新建SpuMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuMapper extends Mapper<SpuEntity> {
}
```

#### 2.2.2.5 service.impl包下新建GoodsServiceImpl

```java
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.SpuEntity;
import com.baidu.shop.mapper.SpuMapper;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.List;

@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {

    @Resource
    private SpuMapper spuMapper;

    @Override
    public Result<PageInfo<SpuEntity>> getSpuInfo(SpuDTO spuDTO) {

        //分页
        if (spuDTO.getPage() != null && spuDTO.getRows()!= null)
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        //用来判断是否上架的
        if(ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());

        //搜索那个框框用来模糊查询的
        if (!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%"+ spuDTO.getTitle() + "%");
        
        //商品管理和品牌传到前台是数字 所以需要转换一下 要不然用户看不懂

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);
        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        return this.setResultSuccess(spuEntityPageInfo);
    }
}
```

**因为 查询的时候 商品分类 和 品牌传到前台的是数字 需要来转换一下 因为用户看不懂**

```java
@Override
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {
        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();
        //判断一下是否上架  spuDTO数据传输
        if (ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable()<2){
            criteria.andEqualTo("saleable",spuDTO.getSaleable());
        }
        //用那个框框用来搜索查询 模糊匹配andLike
        if (!StringUtils.isEmpty(spuDTO.getTitle())){
            criteria.andLike("title","%" + spuDTO.getTitle() + "%");
        }
        //分页 用了 baseDTO类的方法   baseBTO是分页的工具类
        if (spuDTO.getPage() != null && spuDTO.getRows()!= null)
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());
        //排序
        if (!StringUtils.isEmpty(spuDTO.getSort()) && !StringUtils.isEmpty(spuDTO.getOrder()))
            PageHelper.orderBy(spuDTO.getOrderBy());
        //用来查询sql
        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        
        //商品分类 和 品牌传到前台是数字 需要用来转换一下 因为用户看不懂
        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);
            //通过分类Id集合查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));

            //遍历结合 并且将分类名称用 "~" 拼接
            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("~"));
            spuDTO1.setCateGoryName(categoryName);

            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());
            return spuDTO1;
        }).collect(Collectors.toList());

        
        //分页  这个才是分页最后的关键
        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        //返回分页以后的数据
//        return this.setResultSuccess(spuEntityPageInfo);
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal() + "" ,spuDTOList);
    }
```

### 2.2.3 商品新增

#### 		2.2.3.1 新增准备工作

​		**vue 项目**

​	**GoodsForm 的 20 line** 

```vue
<!--商品分类-->
   <v-cascader
     url="/category/list"
     required
     showAllLevels
     v-model="goods.categories"
     label="请选择商品分类"
    />
```

修改 line 349 

```vue
    "goods.categories": {
      deep: true,
      handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId/", {
              params: {
                cid: this.goods.categories[2].id,
              },
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specParam/getSpecParamInfo", {
              params: {
                cid: this.goods.categories[2].id,
              },
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit) {
                 
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({ id, name, generic, numeric, unit }) => {
                if (generic) {
                  const o = { id, name, numeric, unit };
                  if (this.isEdit) {
                    o.v = specs[id];
                  }
                  arr1.push(o);
                } else {
                  const o = { id, name, options: [] };
                  if (this.isEdit) {
                    o.options = template[id];
                  }
                  arr2.push(o);
                }
              });
              this.specs = arr1; // 通用规格
              this.specialSpecs = arr2; // 特有规格
            });
        }
      },
    },
```

line 84

```vue
      <!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload" />
      </v-stepper-content>
```

修改 line 279

```vue
            //images: images ? images.join(",") : '', // 图片
            images: images ? images.map((image) => image.data).join(",") : "", // 图片
```

修改  Editor.vue

​		修改图片会显得路径  editor 93行

```vue
      this.$http.post(this.uploadUrl, data)
          .then(resp => {
            if (resp.data.data) {
              this.editor.insertEmbed(this.editor.getSelection().index, 'image', resp.data.data)
            }
          })
```

**service-api-xxx 的 service 包下新建BrandService**

```java
@ApiOperation(value = "通过分类id获取品牌")
@GetMapping(value = "brand/getBrandInfoByCategoryId")
Result<List<BrandEntity>> getBrandInfoByCategoryId(@NotNull Integer cid);
```

**service-xxx 写的 Mapper包下建service-xxx**

```java
@Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id= #{cid})")
List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
```

**在 BrandServiceImpl 中写**

```java
@Override
public Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid) {
    List<BrandEntity> list = mapper.getBrandInfoByCategoryId(cid);
    return this.setResultSuccess(list);
}
```

**在 SpecificationServiceImpl**

```java
@Override
public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {
    SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
    Example example = new Example(SpecParamEntity.class);
    Example.Criteria criteria = example.createCriteria();

    if(ObjectUtil.isNotNull(specParamEntity.getGroupId()))
        criteria.andEqualTo("groupId",specParamEntity.getGroupId());
    if(ObjectUtil.isNotNull(specParamEntity.getCid()))
        criteria.andEqualTo("cid",specParamEntity.getCid());
    List<SpecParamEntity> specParamMappers = specParamMapper.selectByExample(example);
    return this.setResultSuccess(specParamMappers);
}
```

#### 2.2.3.2新增商品 (商品传值接值)

​	**在 service-api-xxx 的  entity包下 新建SpuDetailEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spu_detail")
@Data
public class SpuDetailEntity {

    @Id
    private Integer spuId;

    private String description;

    private String genericSpec;

    private String specialSpec;

    private String packingList;

    private String afterService;
}
```

**在 service-api-xxx 的  entity包下 新建 SkuEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Table(name = "tb_sku")
@Data
public class SkuEntity {
    @Id  //这用long类型是因为在新增的话已经超出int类型的范围了
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;
}
```

**StockEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_stock")
@Data
public class StockEntity {

    @Id
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    private Integer stock;
}
```

**在dto包下新建SpuDetailDTO**

```java
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {

    @ApiModelProperty(value = "spu主键",example = "1")
    @NotNull(message = "spu主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    @NotNull(message = "通用规格参数数据不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    @NotNull(message = "特有规格参数不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;

}
```

**SkuDTO**

```java
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

@ApiModel(value = "sku属性数据传输类")
@Data
public class SkuDTO {
    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Long id;

    @ApiModelProperty(value = "spu主键", example = "1")
    @NotNull(message = "Spu主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    @NotEmpty(message = "商品标题不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String title;

    @ApiModelProperty(value = "商品的图片，多个图片以‘,’分割")
    private String images;

    @ApiModelProperty(value = "销售价格", example = "1")
    @NotNull(message = "销售价格不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用linkedHashMap，保证有序")
    private String ownSpec;

    //注意此处使用boolean值来接,在service中处理一下就可以了
    @ApiModelProperty(value = "是否有效，0无效，1有效", example = "1")
    @NotNull(message = "是否有效不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean enable;

    @ApiModelProperty(value = "创建时间")
    @NotNull(message = "创建时间不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    @NotNull(message = "最后修改时间不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Date lastUpdateTime;

    @ApiModelProperty(value = "库存")
    @NotNull(message = "库存不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer stock;
}
```

**StockDTO**

```java
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

@ApiModel(value = "库存数据传输类")
@Data
public class StockDTO {
    @ApiModelProperty(value = "sku主键", example = "1")
    @NotNull(message = "sku主键不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存", example = "1")
    private Integer seckillStock;

    @ApiModelProperty(value = "秒杀总数量", example = "1")
    private Integer seckillTotal;

    @ApiModelProperty(value = "库存数量", example = "1")
    @NotNull(message = "库存数量不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer stock;
}
```

 **修改SpuDTO**

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

@ApiModel(value = "spu数据传出DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键" ,example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "一级类目id",example = "1")
    @NotNull(message = "一级类目id不能为空",groups = {MingruiOperation.Add.class ,MingruiOperation.Update.class})
    private Integer cid1;

    @ApiModelProperty(value = "二级类目id",example = "1")
    @NotNull(message = "二级类目的不能为空",groups = {MingruiOperation.Add.class ,MingruiOperation.Update.class})
    private Integer cid2;

    @ApiModelProperty(value = "三级类目id",example = "1")
    @NotNull(message = "三级类目的不能为空",groups = {MingruiOperation.Add.class ,MingruiOperation.Update.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class ,MingruiOperation.Update.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    @NotNull(message = "是否上架不能为空",groups = {MingruiOperation.Add.class ,MingruiOperation.Update.class})
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    @NotNull(message = "是否有效不能为空",groups = {MingruiOperation.Add.class ,MingruiOperation.Update.class})
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    @NotNull(message = "添加时间不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    private String brandName;

    private String cateGoryName;

    @ApiModelProperty(value = "大字段数据")
    private SpuDetailDTO spuDetail;

    @ApiModelProperty(value = "sku属性数据集合")
    private List<SkuDTO> skus;
}
```

**GoodsService**

```java
@ApiOperation(value = "新增商品")
@PostMapping(value = "goods/save")
Result<JSONObject> saveGoods(@Validated({MingruiOperation.Add.class}) @RequestBody SpuDTO spuDTO);
```

**GoodsServiceImpl**

```java
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
    System.out.println(spuDTO);
    return this.setResultSuccess();
}

```

**vue 项目 GoodsForm.vue line:277**

```
this.$emit("closeForm");
```

**service-xxx 的 mapper包下新建mapper SpuDetailMapper**

```java
public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}
```

**SkuMapper**

```java
public interface SkuMapper extends Mapper<SkuEntity> {
}

```

**StockMapper**

```java
public interface StockMapper extends Mapper<StockEntity> {
}
```

**GoodsServiceImpl**   因为和修改用到的代码重复了  所以提出来了  saveSkuAndStockInfo

```java
   @Resource
    private SpuDetailMapper spuDetailMapper;

    @Resource
    private SkuMapper skuMapper;

    @Resource
    private StockMapper stockMapper;



@Override
@Transactional
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {

    //要是直接 new date 的话 CreateTime  和  LastUpdateTime 两次的时间有差别 不一致
    //加这个final 是为了防止 时间被修改
    final Date date = new Date();
    //新增spu  新增spu的时候返回主键
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
    spuEntity.setSaleable(1);
    spuEntity.setValid(1);
    spuEntity.setCreateTime(date);
    spuEntity.setLastUpdateTime(date);
    spuMapper.insertSelective(spuEntity);

    //新增spuDetail
    SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
    SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
    spuDetailEntity.setSpuId(spuEntity.getId());
    spuDetailMapper.insertSelective(spuDetailEntity);

    //新增sku
    //因为和修改用到的代码重复了  所以提出来了  saveSkuAndStockInfo
    this.saveSkuAndStockInfo(spuDTO,spuEntity.getId(),date);
    return this.setResultSuccess();
}
```

​	前台Vue

GoodsForm.vue

```vue
<template>
  <v-stepper v-model="step">
    <v-stepper-header>
      <v-stepper-step :complete="step > 1" step="1">基本信息1</v-stepper-step>
      <v-divider />
      <v-stepper-step :complete="step > 2" step="2">商品描述2</v-stepper-step>
      <v-divider />
      <v-stepper-step :complete="step > 3" step="3">规格参数3</v-stepper-step>
      <v-divider />
      <v-stepper-step step="4">SKU属性</v-stepper-step>
    </v-stepper-header>
    <v-stepper-items>
      <!--1、基本信息-->
      <v-stepper-content step="1">
        <v-flex class="xs10 mx-auto">
          <v-form v-model="valid" ref="basic">
            <v-layout row>
              <v-flex xs5>
                <!--商品分类-->
                <v-cascader
                  url="/category/list"
                  required
                  showAllLevels
                  v-model="goods.categories"
                  label="请选择商品分类"
                />
              </v-flex>
              <v-spacer />
              <v-flex xs5>
                <!--品牌-->
                <v-select
                  :items="brandOptions"
                  item-text="name"
                  item-value="id"
                  label="所属品牌"
                  v-model="goods.brandId"
                  required
                  autocomplete
                  clearable
                  dense
                  chips
                  :rules="[(v) => !!v || '品牌不能为空']"
                >
                  <template slot="selection" slot-scope="data">
                    <v-chip small>{{ data.item.name }}</v-chip>
                  </template>
                </v-select>
              </v-flex>
            </v-layout>
            <v-text-field
              label="商品标题"
              v-model="goods.title"
              :counter="200"
              required
              :rules="[(v) => !!v || '商品标题不能为空']"
              hide-details
            />
            <v-text-field
              label="商品卖点"
              v-model="goods.subTitle"
              :counter="200"
              hide-details
            />
            <v-text-field
              label="包装清单"
              v-model="goods.spuDetail.packingList"
              :counter="1000"
              multi-line
              :rows="3"
              hide-details
            />
            <v-text-field
              label="售后服务"
              v-model="goods.spuDetail.afterService"
              :counter="1000"
              multi-line
              :rows="3"
              hide-details
            />
          </v-form>
        </v-flex>
      </v-stepper-content>
      <!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload" />
      </v-stepper-content>
      <!--3、规格参数-->
      <v-stepper-content step="3">
        <v-flex class="xs10 mx-auto px-3">
          <!--遍历整个规格参数-->
          <v-card class="my-2">
            <v-container grid-list-md fluid>
             <div> <v-layout wrap row justify-space-between class="px-5">
                <v-flex xs12 sm5 v-for="(param,index) in specs" :key="index">
                   <v-text-field
                    :label="param.name"
                    v-model="param.v"
                    :suffix="param.unit || ''"
                  />
                </v-flex>
              </v-layout></div>
            </v-container>
          </v-card>
        </v-flex>
      </v-stepper-content>
      <!--4、SKU属性-->
      <v-stepper-content step="4">
        <v-flex class="mx-auto">
          <!--遍历特有规格参数-->
          <v-card
            flat
            v-for="spec in specialSpecs"
            :key="spec.name + new Date().getTime()"
          >
            <!--特有参数的标题-->
            <div class="subheading">{{ spec.name }}:</div>
            <!--特有参数的待选项，需要判断是否有options，如果没有，展示文本框，让用户自己输入-->
            <v-card-text class="px-5">
              <div
                v-for="i in spec.options.length + 1"
                :key="i"
                class="layout row px-5"
              >
                <v-text-field
                  :placeholder="'新的' + spec.name + ':'"
                  class="flex xs10"
                  auto-grow
                  v-model="spec.options[i - 1]"
                  v-bind:value="i"
                  single-line
                  hide-details
                />
                <v-btn
                  @click="spec.options.splice(i - 1, 1)"
                  v-if="i <= spec.options.length"
                  icon
                >
                  <i class="el-icon-delete" />
                </v-btn>
              </div>
            </v-card-text>
          </v-card>
          <v-card class="elevation-0">
            <!--标题-->
            <div class="subheading py-3">SKU列表:</div>
            <v-divider />
            <!--SKU表格，hide-actions因此分页等工具条-->
            <v-data-table
              :items="skus"
              :headers="headers"
              hide-actions
              item-key="indexes"
              class="elevation-0"
            >
              <template slot="items" slot-scope="props">
                <tr @click="props.expanded = !props.expanded">
                  <!--价格和库存展示为文本框-->
                  <td
                    v-for="(v, k) in props.item"
                    :key="k"
                    v-if="['price', 'stock'].includes(k)"
                    class="text-xs-center"
                  >
                    <v-text-field
                      single-line
                      v-model="props.item[k]"
                      @click.stop=""
                    />
                  </td>
                  <!--enable展示为checkbox-->
                  <td class="text-xs-center" v-else-if="k === 'enable'">
                    <v-checkbox v-model="props.item[k]" />
                  </td>
                  <!--indexes和images不展示，其它展示为普通文本-->
                  <td
                    class="text-xs-center"
                    v-else-if="k !== 'images' && k !== 'indexes'"
                  >
                    {{ v.v }}
                  </td>
                </tr>
              </template>
              <!--点击表格后展开-->
              <template slot="expand" slot-scope="props">
                <v-card class="elevation-2 flex xs11 mx-auto my-2">
                  <!--图片上传组件-->
                  <v-upload v-model="props.item.images" url="/upload" />
                </v-card>
              </template>
            </v-data-table>
          </v-card>
        </v-flex>
        <!--提交按钮-->
        <v-flex xs3 offset-xs9>
          <v-btn color="info" @click="submit">保存商品信息</v-btn>
        </v-flex>
      </v-stepper-content>
    </v-stepper-items>
  </v-stepper>
</template>

<script>
export default {
  name: "goods-form",
  props: {
    oldGoods: {
      type: Object,
    },
    isEdit: {
      type: Boolean,
      default: false,
    },
    step: {
      type: Number,
      default: 1,
    },
  },
  data() {
    return {
      valid: false,
      goods: {
        categories: [], // 商品分类信息
        brandId: 0, // 品牌id信息
        title: "", // 标题
        subTitle: "", // 子标题
        spuDetail: {
          packingList: "", // 包装列表
          afterService: "", // 售后服务
          description: "", // 商品描述
        },
      },
      brandOptions: [], // 品牌列表
      specs: [], // 规格参数的模板
      specialSpecs: [], // 特有规格参数模板
    };
  },
  methods: {
    submit() {
      // 表单校验。
      if (!this.$refs.basic.validate) {
        this.$message.error("请先完成表单内容！");
      }
      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中
      const {
        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],
        ...goodsParams
      } = this.goods;
      // 处理规格参数
      const specs = {};
      this.specs.forEach(({ id, v }) => {
        specs[id] = v;
      });
      // 处理特有规格参数模板
      const specTemplate = {};
      this.specialSpecs.forEach(({ id, options }) => {
        specTemplate[id] = options;
      });
      // 处理sku
      const skus = this.skus
        .filter(s => s.enable)
        .map(({ price, stock, enable, images, indexes, ...rest }) => {
          // 标题，在spu的title基础上，拼接特有规格属性值
          const title =
            goodsParams.title +
            " " +
            Object.values(rest)
              .map((v) => v.v)
              .join(" ");
          const obj = {};
          Object.values(rest).forEach((v) => {
            obj[v.id] = v.v;
          });
          return {
            price: this.$format(price), // 价格需要格式化
            stock,
            indexes,
            enable,
            title, // 基本属性
            //images: images ? images.join(",") : '', // 图片
            images: images ? images.map((image) => image.data).join(",") : "", // 图片
            ownSpec: JSON.stringify(obj), // 特有规格参数
          };
        });
      Object.assign(goodsParams, {
        cid1,
        cid2,
        cid3, // 商品分类
        skus, // sku列表
      });
      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);
      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);

      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams,
      })
        .then(() => {
          // 成功，关闭窗口
          this.$emit("closeForm");
          // 提示成功
          this.$message.success("保存成功了");
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    },
  },
  watch: {
    oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "", // 商品描述
            },
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

        window.setTimeout(() => {
           // 先得到分类名称
          const names = val.cateGoryName.split("/");
          // 组织商品分类数据
          this.goods.categories = [
            { id: val.cid1, name: names[0] },
            { id: val.cid2, name: names[1] },
            { id: val.cid3, name: names[2] },
          ];
        },100)
          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      },
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId/", {
              params: {
                cid: this.goods.categories[2].id,
              },
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specParam/getSpecParamInfo", {
              params: {
                cid: this.goods.categories[2].id,
              },
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit) {
                 
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({ id, name, generic, numeric, unit }) => {
                if (generic) {
                  const o = { id, name, numeric, unit };
                  if (this.isEdit) {
                    o.v = specs[id];
                  }
                  arr1.push(o);
                } else {
                  const o = { id, name, options: [] };
                  if (this.isEdit) {
                    o.options = template[id];
                  }
                  arr2.push(o);
                }
              });
              this.specs = arr1; // 通用规格
              this.specialSpecs = arr2; // 特有规格
            });
        }
      },
    },
  },
  computed: {
    skus() {
      // 过滤掉用户没有填写数据的规格参数
      const arr = this.specialSpecs.filter((s) => s.options.length > 0);
      // 通过reduce进行累加笛卡尔积
      return arr.reduce(
        (last, spec, index) => {
          const result = [];
          last.forEach((o) => {
            spec.options.forEach((option, i) => {
              const obj = JSON.parse(JSON.stringify(o));
              obj[spec.name] = { v: option, id: spec.id };
              obj.indexes = (obj.indexes || "") + "_" + i;
              if (index === arr.length - 1) {
                obj.indexes = obj.indexes.substring(1);
                // 如果发现是最后一组，则添加价格、库存等字段
                Object.assign(obj, {
                  price: 0,
                  stock: 0,
                  enable: false,
                  images: [],
                });
                if (this.isEdit) {
                  // 如果是编辑，则回填sku信息
                  const sku = this.goods.skus.get(obj.indexes);
                  if (sku != null) {
                    const { price, stock, enable, images } = sku;
                    Object.assign(obj, {
                      price: this.$format(price),
                      stock,
                      enable,
                      images: images ? images.split(",") : [],
                    });
                  }
                }
              }
              result.push(obj);
            });
          });
          return result;
        },
        [{}]
      );
    },
    headers() {
      if (this.skus.length <= 0) {
        return [];
      }
      const headers = [];
      Object.keys(this.skus[0]).forEach((k) => {
        let value = k;
        if (k === "price") {
          // enable，表头要翻译成“价格”
          k = "价格";
        } else if (k === "stock") {
          // enable，表头要翻译成“库存”
          k = "库存";
        } else if (k === "enable") {
          // enable，表头要翻译成“是否启用”
          k = "是否启用";
        } else if (k === "images" || k === "indexes") {
          // 图片和索引不在表格中展示
          return;
        }
        headers.push({
          text: k,
          align: "center",
          sortable: false,
          value,
        });
      });
      return headers;
    },
  },
};
</script>

<style scoped>
</style>

```

Goods.vue

```vue
<template>
  <v-card>
    <v-toolbar class="elevation-0">
      <v-btn @click="addItem" color="primary">新增商品</v-btn>
      <v-spacer/>
      <v-flex xs3>
        状态：
        <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>
      </v-flex>
      <v-flex xs3>
        <v-text-field
          append-icon="search"
          label="搜索"
          single-line
          hide-details
          v-model="search.key"
        />
      </v-flex>
    </v-toolbar>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.title }}</td>
        <td class="text-xs-center">{{ props.item.cateGoryName}}</td>
        <td class="text-xs-center">{{ props.item.brandName }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon small @click="editItem(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon small @click="deleteItem(props.item.id)">
            <i class="el-icon-delete"/>
          </v-btn>
          <v-btn icon small v-if="props.item.saleable">上架</v-btn>
          <v-btn icon v-else>下架</v-btn>
        </td>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-if="show" v-model="show" max-width="900" scrollable persistent>
      <v-card>
        <v-toolbar dense dark color="primary">
          <v-toolbar-title>{{isEdit ? '修改商品' : '新增商品'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="closeForm">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text style="height: 600px;">
          <!-- 表单 -->
          <goods-form :oldGoods="selectedGoods" :isEdit="isEdit" :step="step" ref="goodsForm" @closeForm="closeForm"/>
        </v-card-text>
        <v-card-actions>
          <v-layout row justify-center>
            <v-flex xs2>
              <v-btn :disabled="step === 1" @click="lastStep">上一步</v-btn>
            </v-flex>
            <v-flex xs2>
              <v-btn :disabled="step === 4" color="primary" @click="nextStep">下一步</v-btn>
            </v-flex>
          </v-layout>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-card>
</template>

<script>
  import GoodsForm from './GoodsForm'
  // import {goodsData} from "../../mockDB";

  export default {
    name: "item",
    components: {
      GoodsForm
    },
    data() {
      return {
        search: {
          key: '',
          saleable: true,
        },// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '标题', align: 'center', sortable: false, value: 'name'},
          {text: '商品分类', align: 'center', sortable: false, value: 'image'},
          {text: '品牌', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        selectedGoods: null, // 选中的商品信息
        isEdit: false, // 判断是编辑还是新增
        step: 1// 表单中的导航条
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      closeForm() {
        this.isEdit = false;
        this.show = false;
        this.step = 1;
        this.selectedGoods = null;
        this.getDataFromApi();
      },
      lastStep() {
        if (this.step === 1) {
          return;
        }
        this.step--;
      },
      nextStep() {
        if (this.step === 4) {
          return;
        }
        if (this.$refs.goodsForm.$refs.basic.validate()) {
          this.step++;
        }
      },
      addItem() {
        this.selectedGoods = null;
        this.isEdit = false;
        this.show = true;
      },
      editItem(item) {
        // this.selectedGoods = item;
        // const names = item.categoryName.split("/");
        // this.selectedGoods.categories = [
        //   {id: item.cid1, name: names[0]},
        //   {id: item.cid2, name: names[1]},
        //   {id: item.cid3, name: names[2]}
        // ];
        // 查询商品详情 
        this.isEdit = true;
        this.show = true;

        //只监控一次
        let obj = item;
        this.$http.get("/goods/getSpuDetailBySpuId",{
          params:{
            spuId:item.id
          }
        }).then(resp =>{
          obj.categories = []; //解决监控到的职位undefined
          //这样写是因为 可以减少监控次数 只监控一次  注意是两层data
          obj.spuDetail = resp.data.data;
          obj.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec); //特有规格参数
          obj.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec); //通用规格参数
          
          
            //监控的次数太多 减少监控
            // this.$http.get("/item/goods/spu/detail/" + item.id)
            //   .then(resp => {
            //     this.selectedGoods.spuDetail = resp.data;
            //     this.selectedGoods.spuDetail.specTemplate = JSON.parse(resp.data.specTemplate);
            //     this.selectedGoods.spuDetail.specifications = JSON.parse(resp.data.specifications);
            //   })
          this.$http.get('goods/getSkuIdBySpuId',{
            params:{
              spuId:item.id
            }
          }).then(resp =>{
            obj.skus = resp.data.data;
            this.selectedGoods = obj;
          }).catch(error => console.log(error))
        })
      },
      deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => { 
            // 发起删除请求
            this.$http.delete("/good/delete?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
      getDataFromApi() {
        this.loading = true;
        this.$http.get('goods/getSpuInfo',{
          params:{
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            saleable: this.search.saleable,
            title: this.search.key
          }
        }).then(resp =>{
          this.items = resp.data.data;
          this.totalItems = resp.data.message-0;
          this.loading = false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
    }
  }
</script>

<style scoped>
  label {
    font-size: 14px;
  }
</style>

```



#### 2.2.4 商品修改

**在 service-api-xxx 的 GoodsService**

```java
@ApiOperation(value = "通过获取spu查询SpuDetail的详细信息")
@GetMapping(value = "goods/getSpuDetailBySpuId")
Result<SpuDetailEntity> getSpuDetailBySpuId(@NotNull Integer spuId);

@ApiOperation(value = "通过spuId获取skuId")
@GetMapping(value = "goods/getSkuIdBySpuId")
Result<List<SkuDTO>> getSkuIdBySpuId(@NotNull Integer spuId);
```

**在 service-xxx 的 SkuMapper**

```java
public interface SkuMapper extends Mapper<SkuEntity> , ,DeleteByIdListMapper<SkuEntity, Long> {

    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkuAndStockBySpuId(Integer spuId);
}
```

**StockMapper**

```java
public interface StockMapper extends Mapper<StockEntity>,DeleteByIdListMapper<StockEntity,Long> {
}
```

**GoodsServiceImpl**

```java
@Override
    @Transactional
    public Result<JsonObject> editGoods(SpuDTO spuDTO) {
        final Date date = new Date();
        //修改 spu
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setLastUpdateTime(date);
        spuMapper.updateByPrimaryKeySelective(spuEntity);

        //修改spuDetail
        spuDetailMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(),SpuDetailEntity.class));

//        //修改sku   //通过spuId查询sku的信息   // 删除完之后再新增
//        Example example = new Example(SkuEntity.class);
//        example.createCriteria().andEqualTo("spuId",spuDTO);
//        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
//
//        //得到sku集合
//        List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
//        skuMapper.deleteByIdList(skuIdList); //通过skuId结合删除sku信息
//        stockMapper.deleteByIdList(skuIdList); //通过skuId集合删除stock信息
        this.deleteSkuAndStock(spuDTO.getId());
        //新增sku
        this.saveSkuAndStockInfo(spuDTO,spuEntity.getId(), date);
        //修改stock
        return this.setResultSuccess();
    }
```

**新增和修改 提 出来的公共代码**

```java
//新增和修改的代码重复了 所以就提出来当做公共的代码 是页面更整洁
private void saveSkuAndStockInfo(SpuDTO spuDTO,Integer spuId,Date date){
    //新增sku
    List<SkuDTO> skus = spuDTO.getSkus();
    skus.stream().forEach(skuDTO -> {

        SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
        skuEntity.setSpuId(spuId);
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });
}
```

#### 2.2.5 删除

​	Goods.vue

```vue
deleteItem(id) {
this.$message
.confirm("此操作将永久删除该商品, 是否继续?")
.then(() => {
// 发起删除请求
this.$http.delete("goods/delete?spuId=" + id).then(() => {
// 删除成功，重新加载数据
this.getDataFromApi();
this.$message.info("删除成功!");
});
})
.catch(() => {
this.$message.info("已取消删除");
});
},

```

**在 service-api-xxx 的GoodsService中写**

```java
 @ApiOperation(value = "删除商品")
    @DeleteMapping(value = "good/delete")
    //@RequestBody 来接收前端传递给后端的json字符串中的数据
    Result<JsonObject> deleteGoods(@NotNull Integer spuId);
```

在 service-xxx 的 GoodsServiceImpl

```java
 @Override
    public Result<JsonObject> deleteGoods(Integer spuId) {
        //删除spu
        spuMapper.deleteByPrimaryKey(spuId);
        //删除SpuDetail
        spuMapper.deleteByPrimaryKey(spuId);

//        //删除spu 和 stock
//        //通过 spuId 查询 sku信息
//        Example example = new Example(SkuEntity.class);
//        example.createCriteria().andEqualTo("spuId",spuId);
//        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
//        //得到sku集合
//        List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
//        skuMapper.deleteByIdList(skuIdList);//通过skuId集合删除sku信息
//        stockMapper.deleteByIdList(skuIdList);//通过skuId集合删除stock信息

        this.deleteSkuAndStock(spuId);
        return this.setResultSuccess();
    }
```

**将和修改的重复代码提取出来**

```java
private void deleteSkuAndStock(Integer spuId){
    //删除spu 和 stock
    //通过 spuId 查询 sku信息
    Example example = new Example(SkuEntity.class);
    example.createCriteria().andEqualTo("spuId",spuId);
    List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
    //得到sku集合
    List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
    skuMapper.deleteByIdList(skuIdList);//通过skuId集合删除sku信息
    stockMapper.deleteByIdList(skuIdList);//通过skuId集合删除stock信息
}
```